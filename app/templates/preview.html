<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>プレビュー - シフト登録RPA</title>
</head>
<body>
  <h1>プレビュー</h1>
  <p>対象: {{ job.uploader_name }}</p>

  {% if events and events|length > 0 %}
  <table border="1" cellspacing="0" cellpadding="6">
    <thead>
      <tr>
        <th>#</th><th>日付</th><th>開始</th><th>終了</th><th>翌日跨ぎ</th><th>件名(コード)</th>
      </tr>
    </thead>
    <tbody>
      {% for e in events %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ e.date }}</td>
        <td>{{ e.start }}</td>
        <td>{{ e.end }}</td>
        <td>{{ 'Yes' if e.get('end_plus1') else '' }}</td>
        <td>{{ e.title }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <form action="/api/commit" method="post" style="margin-top:16px;">
    <input type="hidden" name="job_id" value="{{ job_id }}" />
    
    {% if authed and calendars %}
      <label for="calendar_id">登録先カレンダー:</label>
      <select name="calendar_id" id="calendar_id" required style="margin-left: 8px; margin-right: 16px; padding: 4px;">
        {% for cal in calendars %}
          <option value="{{ cal.id }}" {% if cal.primary %}selected{% endif %}>
            {% if cal.primary %}🌟 {% endif %}{{ cal.summary }}{% if cal.primary %} (メインカレンダー){% endif %}
          </option>
        {% endfor %}
      </select>
      <button type="submit">選択したカレンダーに登録</button>
    {% elif authed %}
      <p style="color: orange;">カレンダーリストを取得できませんでした。</p>
      <button type="submit">デフォルトカレンダーに登録</button>
    {% else %}
      <p style="color: red;">Googleカレンダーに登録するには、先に認証を完了してください。</p>
      <a href="/auth/google" style="background: #4285f4; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px;">Google認証</a>
    {% endif %}
  </form>
  {% else %}
    <p>イベントがありません</p>
  {% endif %}

  <p style="margin-top:16px;"><a href="/">← 戻る</a></p>
</body>
</html>